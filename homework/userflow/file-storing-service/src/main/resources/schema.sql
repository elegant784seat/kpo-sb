DROP TABLE IF EXISTS reports CASCADE;
DROP TABLE IF EXISTS files CASCADE;
DROP TABLE IF EXISTS works CASCADE;
DROP TABLE IF EXISTS users CASCADE;

DROP SEQUENCE IF EXISTS users_id_seq CASCADE;
DROP SEQUENCE IF EXISTS works_id_seq CASCADE;
DROP SEQUENCE IF EXISTS files_id_seq CASCADE;
DROP SEQUENCE IF EXISTS reports_id_seq CASCADE;


CREATE TABLE IF NOT EXISTS users (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS works (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS files (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    work_id INTEGER NOT NULL,
    student_id INTEGER NOT NULL,
    original_file_name VARCHAR(250) NOT NULL,
    s3_key VARCHAR(50) UNIQUE NOT NULL,
    mime_type VARCHAR(100),
    file_size BIGINT NOT NULL,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_files_work FOREIGN KEY (work_id) REFERENCES works (id) ON DELETE CASCADE,
    CONSTRAINT fk_files_student FOREIGN KEY (student_id) REFERENCES users (id) ON DELETE CASCADE,
    CONSTRAINT unique_student_work UNIQUE (student_id, work_id)
);

CREATE TABLE IF NOT EXISTS reports (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    work_id INTEGER NOT NULL,
    work_name VARCHAR NOT NULL,
    student_id INTEGER NOT NULL,
    student_name VARCHAR NOT NULL,
    plagiarism_detected BOOLEAN NOT NULL,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_work_student UNIQUE (work_id, student_id)
);